# スクリプトの実行手順

## 前提条件
各ノードにはSSHで接続できる必要があります。これによりスクリプトは各ノードでのコマンドの実行を制御します。

マスターノードはスレーブノードへのSSH接続をサポートしている必要があります。SSHエージェントフォワーディングを使用すると、マスターノードからスレーブノードに対するSSH接続をシームレスに行うことができます。以下のコマンドをマスターノードで実行してSSHエージェントフォワーディングを有効にします：

```bash
ssh -A user@master_node
```
その後、以下のコマンドを実行してSSH認証ソケットの環境変数を転送します：

```bash
eval $(ssh-agent)
```

## スクリプトの実行

全ての確認が完了したら、スクリプトを実行します：

```bash
cd /model/mosaicml/llm-foundry
bash 2node16gpu.sh
```

```
scripts/mpt-13b-2node16gpu.yaml
```
をいじれば、いろいろ変えられます


おそらく2nodeより多い場合でも作動すると思うのですが検証はできていないです
後 動くことを優先したためフルパスになっていたりして散らかっています。7月18日現在 


## 2node16gpu.shに下記の処理を行うようにしていますが、もし何かしらのエラーがある場合(参考に)
ポートが既に使用されている場合

ポートが既に使用されているときは、そのポートをkillします。以下のコマンドを使用して、指定したポートを使用しているプロセスを探します：

```bash
lsof -i :2221
```
続いて表示されたプロセスIDを使って該当のプロセスをkillします：
マスタノードでkillすれば タイムアウトで少し待てば他のノードでもポートが閉じられます

時間がある時にスクリプトでまとめて消せるようなものを用意します。


ストリーミングデータセットでエラーが発生する場合

Pythonインタプリタで以下のコードを実行します：

```python
source venv/bin/activate
python
import streaming
streaming.base.util.clean_stale_shared_memory()
```
これは全てのノードで実行する必要があります。